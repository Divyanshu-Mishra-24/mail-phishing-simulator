<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Phishing Risk Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --green:       #00d084;
      --green2:      #00e896;
      --green3:      #00f5a8;
      --green-dark:  #00a866;
      --green-dim:   rgba(0,208,132,0.12);
      --green-glow:  rgba(0,208,132,0.22);
      --bg:          #0d0d0d;
      --sidebar:     #111111;
      --card:        #181818;
      --card2:       #1f1f1f;
      --card3:       #252525;
      --border:      rgba(255,255,255,0.07);
      --border2:     rgba(255,255,255,0.04);
      --text:        #f0f0f0;
      --text-dim:    #a0a0a0;
      --text-muted:  #5a5a5a;
      --yellow:      #f5c842;
      --red:         #f43f5e;
      --orange:      #f97316;
      --blue:        #3b82f6;
      --sidebar-w:   220px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      font-size: 13px;
    }

    /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
    .sidebar {
      width: var(--sidebar-w);
      background: var(--sidebar);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 0; left: 0; bottom: 0;
      z-index: 100;
      flex-shrink: 0;
    }
    .sidebar-logo {
      padding: 20px 20px 16px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 10px;
    }
    .logo-icon {
      width: 30px; height: 30px;
      background: linear-gradient(135deg, var(--green) 0%, var(--green-dark) 100%);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px; color: #000; font-weight: 800;
      box-shadow: 0 4px 12px var(--green-glow);
    }
    .logo-text {
      font-size: 1rem; font-weight: 700;
      color: var(--text);
      letter-spacing: -0.02em;
    }

    .sidebar-section-label {
      font-size: 0.62rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.1em;
      color: var(--text-muted);
      padding: 18px 20px 6px;
    }
    .sidebar-nav { flex: 1; padding-bottom: 16px; overflow-y: auto; }
    .nav-item {
      display: flex; align-items: center; gap: 10px;
      padding: 9px 20px;
      border-radius: 0;
      cursor: pointer;
      color: var(--text-dim);
      font-size: 0.82rem; font-weight: 500;
      transition: all 0.18s;
      position: relative;
      border-left: 3px solid transparent;
    }
    .nav-item:hover { color: var(--text); background: rgba(255,255,255,0.04); }
    .nav-item.active {
      color: var(--green);
      background: var(--green-dim);
      border-left-color: var(--green);
    }
    .nav-item .nav-icon { font-size: 15px; width: 18px; text-align: center; }
    .nav-badge {
      margin-left: auto;
      background: var(--green);
      color: #000;
      font-size: 0.6rem; font-weight: 700;
      padding: 1px 6px; border-radius: 10px;
    }

    /* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
    .topbar {
      position: fixed;
      top: 0; left: var(--sidebar-w); right: 0;
      height: 52px;
      background: var(--sidebar);
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 24px;
      z-index: 99;
    }
    .topbar-left { display: flex; align-items: center; gap: 16px; }
    .page-title { font-size: 1rem; font-weight: 600; color: var(--text); }
    .breadcrumb { font-size: 0.74rem; color: var(--text-muted); }
    .breadcrumb span { color: var(--green); }

    .topbar-right { display: flex; align-items: center; gap: 12px; }
    .search-box {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 20px; padding: 5px 14px;
      display: flex; align-items: center; gap: 8px;
      color: var(--text-muted); font-size: 0.78rem;
    }
    .search-box input {
      background: none; border: none; outline: none;
      color: var(--text); font-family: 'Inter',sans-serif; font-size: 0.78rem;
      width: 140px;
    }
    .search-box input::placeholder { color: var(--text-muted); }

    .icon-btn {
      width: 32px; height: 32px; border-radius: 50%;
      background: var(--card); border: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 14px; color: var(--text-dim);
      transition: all 0.2s; position: relative;
    }
    .icon-btn:hover { border-color: var(--green); color: var(--green); }
    .icon-btn .dot {
      position: absolute; top: -2px; right: -2px;
      width: 8px; height: 8px; background: var(--green);
      border-radius: 50%; border: 1px solid var(--sidebar);
    }

    /* ‚îÄ‚îÄ MAIN CONTENT ‚îÄ‚îÄ */
    .main {
      margin-left: var(--sidebar-w);
      margin-top: 52px;
      padding: 22px 24px;
      flex: 1;
      min-height: calc(100vh - 52px);
    }

    /* ‚îÄ‚îÄ KPI CARDS ‚îÄ‚îÄ */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 14px;
      margin-bottom: 20px;
    }
    .kpi-card {
      border-radius: 10px;
      padding: 16px 18px;
      position: relative;
      overflow: hidden;
      cursor: default;
    }
    .kpi-card-green  { background: linear-gradient(135deg, #00d084 0%, #00a866 100%); color: #000; }
    .kpi-card-green2 { background: linear-gradient(135deg, #00b876 0%, #008f5a 100%); color: #000; }
    .kpi-card-green3 { background: linear-gradient(135deg, #009e68 0%, #007a50 100%); color: #000; }
    .kpi-card-dark   { background: linear-gradient(135deg, #007850 0%, #005a3a 100%); color: #e0ffe8; }

    .kpi-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    .kpi-label-text { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; opacity: 0.75; }
    .kpi-icon-wrap { font-size: 1.4rem; opacity: 0.6; }
    .kpi-change { font-size: 0.68rem; font-weight: 600; opacity: 0.75; }
    .kpi-value-big { font-size: 1.7rem; font-weight: 700; letter-spacing: -0.03em; line-height: 1; }
    .kpi-sub-row { display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.68rem; opacity: 0.65; font-weight: 500; }
    .kpi-card::after {
      content: ''; position: absolute;
      right: -15px; top: -15px;
      width: 70px; height: 70px;
      background: rgba(255,255,255,0.08);
      border-radius: 50%;
    }

    /* ‚îÄ‚îÄ SECTION HEADER ‚îÄ‚îÄ */
    .section-row {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 14px;
    }
    .section-title {
      font-size: 0.85rem; font-weight: 600; color: var(--text);
    }

    /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }
    .card-header {
      padding: 14px 18px;
      border-bottom: 1px solid var(--border2);
      display: flex; align-items: center; justify-content: space-between;
    }
    .card-title {
      font-size: 0.82rem; font-weight: 600; color: var(--text);
    }
    .card-body { padding: 18px; }

    /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
    .btn {
      font-family: 'Inter', sans-serif;
      font-size: 0.78rem; font-weight: 600;
      padding: 7px 16px; border-radius: 7px; border: none;
      cursor: pointer; transition: all 0.2s;
    }
    .btn-green {
      background: linear-gradient(135deg, var(--green) 0%, var(--green-dark) 100%);
      color: #000;
      box-shadow: 0 3px 10px var(--green-glow);
    }
    .btn-green:hover { filter: brightness(1.1); box-shadow: 0 4px 16px var(--green-glow); }
    .btn-green:disabled { opacity: 0.3; cursor: not-allowed; filter: none; box-shadow: none; }

    .btn-ghost {
      background: var(--card2); border: 1px solid var(--border);
      color: var(--text-dim);
    }
    .btn-ghost:hover { border-color: var(--green); color: var(--green); }

    .btn-scan {
      background: linear-gradient(135deg, #00d084 0%, #00a866 100%);
      color: #000; font-weight: 700;
      box-shadow: 0 3px 10px var(--green-glow);
    }
    .btn-scan:hover { filter: brightness(1.1); }
    .btn-scan:disabled { opacity: 0.3; cursor: not-allowed; filter: none; box-shadow: none; }

    /* ‚îÄ‚îÄ FORM ELEMENTS ‚îÄ‚îÄ */
    .form-label {
      display: block; font-size: 0.7rem; font-weight: 600;
      color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.07em;
      margin-bottom: 5px;
    }
    .form-input {
      background: var(--card2); border: 1px solid var(--border);
      border-radius: 7px; color: var(--text);
      padding: 8px 12px; width: 100%;
      font-family: 'Inter', sans-serif; font-size: 0.82rem;
      outline: none; transition: border-color 0.2s, box-shadow 0.2s;
    }
    .form-input:focus {
      border-color: var(--green);
      box-shadow: 0 0 0 3px rgba(0,208,132,0.12);
    }
    .form-input::placeholder { color: var(--text-muted); }
    select.form-input option { background: var(--card2); }
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; }
    input[type=checkbox] { accent-color: var(--green); width: 14px; height: 14px; }

    /* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
    .tab-strip {
      display: flex; gap: 4px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 20px;
    }
    .tabBtn {
      font-family: 'Inter', sans-serif;
      font-size: 0.8rem; font-weight: 500;
      padding: 10px 18px;
      border: none; background: none;
      color: var(--text-muted);
      cursor: pointer; transition: all 0.18s;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
    }
    .tabBtn:hover { color: var(--text); }
    .tabBtn.active-tab {
      color: var(--green);
      border-bottom-color: var(--green);
      font-weight: 600;
    }

    /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th {
      font-size: 0.68rem; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.09em; color: var(--text-muted);
      padding: 0 16px 10px 0; border-bottom: 1px solid var(--border);
      text-align: left; white-space: nowrap;
    }
    .data-table td {
      padding: 11px 16px 11px 0;
      font-size: 0.8rem; color: var(--text-dim);
      border-bottom: 1px solid var(--border2);
    }
    .data-table tbody tr:hover td { background: rgba(255,255,255,0.02); }

    /* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
    .badge {
      display: inline-block; padding: 2px 10px; border-radius: 20px;
      font-size: 0.67rem; font-weight: 600; letter-spacing: 0.04em;
    }
    .badge-green    { background: rgba(0,208,132,0.12); color: var(--green); border: 1px solid rgba(0,208,132,0.25); }
    .badge-yellow   { background: rgba(245,200,66,0.12); color: #f5c842; border: 1px solid rgba(245,200,66,0.25); }
    .badge-orange   { background: rgba(249,115,22,0.12); color: #f97316; border: 1px solid rgba(249,115,22,0.25); }
    .badge-red      { background: rgba(244,63,94,0.12);  color: #f43f5e; border: 1px solid rgba(244,63,94,0.25); }
    .badge-auth-on  { background: rgba(0,208,132,0.1); color: var(--green2); border: 1px solid rgba(0,208,132,0.3); padding: 3px 12px; border-radius: 20px; font-size: 0.72rem; font-weight: 600; }
    .badge-auth-off { background: var(--card); color: var(--text-muted); border: 1px solid var(--border); padding: 3px 12px; border-radius: 20px; font-size: 0.72rem; font-weight: 600; }

    /* ‚îÄ‚îÄ GRID HELPERS ‚îÄ‚îÄ */
    .grid-2   { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .grid-3-1 { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; }
    .space-y > * + * { margin-top: 13px; }
    .hidden { display: none !important; }

    /* ‚îÄ‚îÄ STAT ROW (inside dist card) ‚îÄ‚îÄ */
    .stat-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 9px 0; border-bottom: 1px solid var(--border2);
    }
    .stat-row:last-child { border-bottom: none; }
    .stat-row-label { font-size: 0.75rem; color: var(--text-muted); }
    .stat-row-value { font-size: 1rem; font-weight: 700; color: var(--green); }

    /* ‚îÄ‚îÄ FACTOR ROW ‚îÄ‚îÄ */
    .factor-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 9px 12px;
      background: var(--card2); border-radius: 7px;
      border: 1px solid var(--border2);
      transition: border-color .18s;
    }
    .factor-item:hover { border-color: rgba(0,208,132,0.25); }
    .factor-name  { font-size: 0.78rem; color: var(--text-dim); }
    .factor-count { font-size: 0.9rem; font-weight: 700; color: var(--green); }

    /* ‚îÄ‚îÄ MSG ‚îÄ‚îÄ */
    .msg { font-size: 0.78rem; margin-top: 10px; }
    .msg-ok   { color: var(--green); }
    .msg-err  { color: var(--red); }
    .msg-info { color: var(--text-muted); }

    /* ‚îÄ‚îÄ ENGINE STATUS ‚îÄ‚îÄ */
    .engine-grid {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 6px; margin-top: 14px;
    }
    .engine-item {
      display: flex; align-items: center; gap: 7px;
      background: var(--card2); border: 1px solid var(--border2);
      border-radius: 6px; padding: 7px 10px; font-size: 0.74rem;
    }
    .engine-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
    .engine-dot.on  { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .engine-dot.idle{ background: var(--yellow); box-shadow: 0 0 6px var(--yellow); }

    /* ‚îÄ‚îÄ INFO BOX ‚îÄ‚îÄ */
    .info-box {
      background: var(--card2); border: 1px solid var(--border);
      border-left: 3px solid var(--green); border-radius: 7px;
      padding: 11px 14px; font-size: 0.76rem; color: var(--text-muted); line-height: 1.6;
    }

    /* scrollbar */
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--green); }
  </style>
</head>
<body>

  <!-- ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="logo-icon">P</div>
      <div class="logo-text">PhishGuard</div>
    </div>
    <nav class="sidebar-nav">
      <div class="sidebar-section-label">Main</div>
      <div class="nav-item active" onclick="showTab('connect')">
        <span class="nav-icon">‚äï</span> Connect
      </div>
      <div class="nav-item" onclick="showTab('dashboard')">
        <span class="nav-icon">‚ñ¶</span> Dashboard
        <span class="nav-badge" id="sidebarBadge" style="display:none">!</span>
      </div>

      <div class="sidebar-section-label">Analysis</div>
      <div class="nav-item" onclick="showTab('results')">
        <span class="nav-icon">‚â°</span> Results
      </div>
      <div class="nav-item" onclick="showTab('settings')">
        <span class="nav-icon">‚öô</span> Settings
      </div>
    </nav>
  </aside>

  <!-- ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ -->
  <div class="topbar">
    <div class="topbar-left">
      <div class="page-title" id="pageTitle">Dashboard</div>
      <div class="breadcrumb">PhishGuard ¬∑ <span id="breadSub">Connect</span></div>
    </div>
    <div class="topbar-right">
      <span id="authBadge" class="badge-auth-off">‚óè Offline</span>
      <button id="logoutBtn" class="hidden btn btn-ghost" type="button">Log out</button>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ -->
  <main class="main">

    <!-- ‚îÄ‚îÄ KPI STRIP (always visible) ‚îÄ‚îÄ -->
    <div class="kpi-grid">
      <div class="kpi-card kpi-card-green">
        <div class="kpi-top">
          <div>
            <div class="kpi-label-text">Scan Status</div>
            <div class="kpi-change">‚óè Live engine</div>
          </div>
          <div class="kpi-icon-wrap">üì°</div>
        </div>
        <div class="kpi-value-big" style="font-size:1.3rem;" id="kpi-status">Standby</div>
        <div class="kpi-sub-row"><span>IMAP</span><span id="kpi-conn-state">Disconnected</span></div>
      </div>
      <div class="kpi-card kpi-card-green2">
        <div class="kpi-top">
          <div>
            <div class="kpi-label-text">Flagged Emails</div>
            <div class="kpi-change">Risk threshold hits</div>
          </div>
          <div class="kpi-icon-wrap">‚ö†</div>
        </div>
        <div class="kpi-value-big" id="kpi-flagged">‚Äì</div>
        <div class="kpi-sub-row"><span>% of total</span><span id="kpi-flag-pct">‚Äì</span></div>
      </div>
      <div class="kpi-card kpi-card-green3">
        <div class="kpi-top">
          <div>
            <div class="kpi-label-text">Safe Emails</div>
            <div class="kpi-change">Low risk score</div>
          </div>
          <div class="kpi-icon-wrap">‚úì</div>
        </div>
        <div class="kpi-value-big" id="kpi-safe">‚Äì</div>
        <div class="kpi-sub-row"><span>% of total</span><span id="kpi-safe-pct">‚Äì</span></div>
      </div>
      <div class="kpi-card kpi-card-dark">
        <div class="kpi-top">
          <div>
            <div class="kpi-label-text">Total Scanned</div>
            <div class="kpi-change">All-time records</div>
          </div>
          <div class="kpi-icon-wrap">üìä</div>
        </div>
        <div class="kpi-value-big" id="kpi-total">‚Äì</div>
        <div class="kpi-sub-row"><span>Emails processed</span><span>‚Üë</span></div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ TAB STRIP ‚îÄ‚îÄ -->
    <div class="tab-strip">
      <button data-tab="connect"   class="tabBtn">Connect</button>
      <button data-tab="dashboard" class="tabBtn">Dashboard</button>
      <button data-tab="results"   class="tabBtn">Results</button>
      <button data-tab="settings"  class="tabBtn">Settings</button>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê CONNECT ‚ïê‚ïê‚ïê‚ïê -->
    <section id="tab-connect" class="tabSection">
      <div class="grid-2">

        <div class="card">
          <div class="card-header">
            <span class="card-title">Connect Mailbox ¬∑ IMAP</span>
          </div>
          <div class="card-body">
            <p style="color:var(--text-muted);font-size:0.75rem;margin-bottom:14px;line-height:1.7;">
              Stores only <strong style="color:var(--text)">encrypted credentials</strong> + derived risk metrics. No raw email bodies are ever persisted.
            </p>
            <form id="connectForm" class="space-y">
              <div>
                <label class="form-label">Provider</label>
                <select id="provider" class="form-input">
                  <option value="gmail">Gmail (IMAP)</option>
                  <option value="outlook">Outlook (IMAP)</option>
                  <option value="custom">Custom IMAP</option>
                </select>
              </div>
              <div>
                <label class="form-label">Email address</label>
                <input id="email" class="form-input" placeholder="you@example.com" required />
              </div>
              <div>
                <label class="form-label">Username <span style="color:var(--text-muted);font-weight:400">(optional)</span></label>
                <input id="username" class="form-input" placeholder="Defaults to email" />
              </div>
              <div>
                <label class="form-label">App password</label>
                <input id="appPassword" class="form-input" placeholder="16-character app password" type="password" required />
              </div>
              <div id="customImap" style="display:none;">
                <div style="display:grid;grid-template-columns:2fr 1fr;gap:10px;margin-bottom:10px;">
                  <div>
                    <label class="form-label">IMAP host</label>
                    <input id="imapHost" class="form-input" placeholder="imap.example.com" />
                  </div>
                  <div>
                    <label class="form-label">Port</label>
                    <input id="imapPort" class="form-input" placeholder="993" type="number" />
                  </div>
                </div>
                <div style="display:flex;align-items:center;gap:8px;">
                  <input id="useSsl" type="checkbox" checked />
                  <label style="font-size:0.78rem;color:var(--text-muted)">Use SSL / TLS</label>
                </div>
              </div>
              <button class="btn btn-green" style="width:100%;" type="submit">Connect Mailbox</button>
            </form>
            <div id="connectMsg" class="msg"></div>
          </div>
        </div>

        <div style="display:flex;flex-direction:column;gap:14px;">
          <div class="card">
            <div class="card-header"><span class="card-title">Scan Emails</span></div>
            <div class="card-body">
              <p style="color:var(--text-muted);font-size:0.75rem;margin-bottom:12px;line-height:1.7;">
                Fetches last N emails, analyzes in-memory, stores only metrics.
              </p>
              <div style="display:flex;align-items:flex-end;gap:10px;margin-bottom:10px;">
                <div style="flex:1;">
                  <label class="form-label">Emails to scan</label>
                  <input id="scanLimit" class="form-input" type="number" min="1" max="200" value="50" />
                </div>
                <button id="scanBtn" class="btn btn-scan" style="padding:8px 20px;white-space:nowrap;" type="button" disabled>‚ñ∂ Scan</button>
              </div>
              <div id="scanMsg" class="msg"></div>
              <div class="info-box" style="margin-top:12px;">
                After scanning, view <strong style="color:var(--text)">Dashboard</strong> for charts and <strong style="color:var(--text)">Results</strong> for per-email summaries.
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header"><span class="card-title">Engine Status</span></div>
            <div class="card-body" style="padding:14px 18px;">
              <div class="engine-grid">
                <div class="engine-item"><div class="engine-dot on"></div><span style="color:var(--text-dim)">SPF Validator</span></div>
                <div class="engine-item"><div class="engine-dot on"></div><span style="color:var(--text-dim)">DKIM Checker</span></div>
                <div class="engine-item"><div class="engine-dot on"></div><span style="color:var(--text-dim)">Link Analyzer</span></div>
                <div class="engine-item"><div class="engine-dot idle"></div><span style="color:var(--text-dim)">ML Classifier</span></div>
                <div class="engine-item"><div class="engine-dot idle"></div><span style="color:var(--text-dim)">Header Inspect</span></div>
                <div class="engine-item"><div class="engine-dot on"></div><span style="color:var(--text-dim)">Domain Lookup</span></div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- ‚ïê‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê‚ïê -->
    <section id="tab-dashboard" class="tabSection hidden">
      <div class="grid-3-1" style="margin-bottom:16px;">
        <div class="card">
          <div class="card-header">
            <span class="card-title">Risk Trend ¬∑ Last 30 Days</span>
            <button id="refreshDashBtn" class="btn btn-ghost" style="padding:5px 12px;font-size:0.72rem;" type="button">‚Üª Refresh</button>
          </div>
          <div class="card-body"><canvas id="trendChart" height="130"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header"><span class="card-title">Distribution</span></div>
          <div class="card-body">
            <canvas id="distChart" height="150"></canvas>
            <div style="margin-top:14px;">
              <div class="stat-row"><span class="stat-row-label">Flagged</span><span class="stat-row-value" id="flaggedCount">0</span></div>
              <div class="stat-row"><span class="stat-row-label">Total</span><span class="stat-row-value" id="totalCount">0</span></div>
            </div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">Top Risk Indicators</span></div>
        <div class="card-body">
          <div id="topFactors" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;"></div>
        </div>
      </div>
    </section>

    <!-- ‚ïê‚ïê‚ïê‚ïê RESULTS ‚ïê‚ïê‚ïê‚ïê -->
    <section id="tab-results" class="tabSection hidden">
      <div class="card">
        <div class="card-header">
          <span class="card-title">Per-Email Risk Summary</span>
          <button id="refreshResultsBtn" class="btn btn-ghost" style="padding:5px 12px;font-size:0.72rem;" type="button">‚Üª Refresh</button>
        </div>
        <div class="card-body" style="overflow-x:auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th>Time (UTC)</th>
                <th>Sender Domain</th>
                <th>Score</th>
                <th>Level</th>
                <th>Risk Factors</th>
              </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
          </table>
          <div id="resultsMsg" class="msg msg-info" style="margin-top:10px;"></div>
        </div>
      </div>
    </section>

    <!-- ‚ïê‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê‚ïê -->
    <section id="tab-settings" class="tabSection hidden">
      <div class="card" style="max-width:460px;">
        <div class="card-header"><span class="card-title">Exposure Configuration</span></div>
        <div class="card-body">
          <p style="color:var(--text-muted);font-size:0.75rem;margin-bottom:14px;line-height:1.7;">Configure scan defaults and alert thresholds.</p>
          <form id="settingsForm" class="space-y">
            <div>
              <label class="form-label">Default scan limit</label>
              <input id="setScanLimit" class="form-input" type="number" min="1" max="200" value="50" />
            </div>
            <div>
              <label class="form-label">Risk threshold (alert trigger)</label>
              <input id="setThreshold" class="form-input" type="number" min="0" max="100" value="60" />
            </div>
            <div>
              <label class="form-label">Scan frequency (minutes)</label>
              <input id="setFrequency" class="form-input" type="number" min="5" max="10080" value="60" />
            </div>
            <button class="btn btn-green" style="width:100%;" type="submit">Save Settings</button>
          </form>
          <div id="settingsMsg" class="msg"></div>
        </div>
      </div>
    </section>

  </main>

  <script>
    Chart.defaults.color = '#5a5a5a';
    Chart.defaults.borderColor = 'rgba(255,255,255,0.06)';
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.font.size = 11;

    const state = { apiKey: localStorage.getItem("apiKey") || "", trendChart: null, distChart: null };

    function setAuthUI() {
      const badge = document.getElementById("authBadge");
      const scanBtn = document.getElementById("scanBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const kpiStatus = document.getElementById("kpi-status");
      const kpiConn   = document.getElementById("kpi-conn-state");
      if (state.apiKey) {
        badge.textContent = "‚óè Online";
        badge.className = "badge-auth-on";
        scanBtn.disabled = false;
        logoutBtn.classList.remove("hidden");
        kpiStatus.textContent = "Connected";
        kpiConn.textContent   = "Active";
        document.getElementById("sidebarBadge").style.display = "inline";
      } else {
        badge.textContent = "‚óè Offline";
        badge.className = "badge-auth-off";
        scanBtn.disabled = true;
        logoutBtn.classList.add("hidden");
        kpiStatus.textContent = "Standby";
        kpiConn.textContent   = "Disconnected";
        document.getElementById("sidebarBadge").style.display = "none";
      }
    }

    async function api(path, { method = "GET", body } = {}) {
      const headers = { "Content-Type": "application/json" };
      if (state.apiKey) headers["X-Api-Key"] = state.apiKey;
      const res = await fetch(path, { method, headers, body: body ? JSON.stringify(body) : undefined });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.detail || `Request failed (${res.status})`);
      return data;
    }

    const tabNames = { connect: 'Connect', dashboard: 'Dashboard', results: 'Results', settings: 'Settings' };

    function showTab(name) {
      document.querySelectorAll(".tabSection").forEach(el => el.classList.add("hidden"));
      document.getElementById(`tab-${name}`).classList.remove("hidden");
      document.querySelectorAll(".tabBtn").forEach(btn => {
        btn.className = btn.getAttribute("data-tab") === name ? "tabBtn active-tab" : "tabBtn";
      });
      // update sidebar active
      document.querySelectorAll(".nav-item").forEach(el => {
        el.classList.toggle("active", el.getAttribute("onclick") === `showTab('${name}')`);
      });
      document.getElementById("pageTitle").textContent = tabNames[name] || name;
      document.getElementById("breadSub").textContent  = tabNames[name] || name;
      if (name === "dashboard") loadDashboard().catch(() => {});
      if (name === "results")   loadResults().catch(() => {});
      if (name === "settings")  loadSettings().catch(() => {});
    }

    function riskBadge(level) {
      if (level === "Low")    return `<span class="badge badge-green">Low</span>`;
      if (level === "Medium") return `<span class="badge badge-yellow">Medium</span>`;
      if (level === "High")   return `<span class="badge badge-orange">High</span>`;
      return `<span class="badge badge-red">Critical</span>`;
    }

    function renderTopFactors(items) {
      const root = document.getElementById("topFactors");
      if (!items || !items.length) {
        root.innerHTML = `<div class="msg msg-info" style="grid-column:1/-1;">No factors yet. Run a scan first.</div>`; return;
      }
      root.innerHTML = items.map(x => `
        <div class="factor-item">
          <span class="factor-name">${x.factor}</span>
          <span class="factor-count">${x.count}</span>
        </div>`).join("");
    }

    function renderResults(items) {
      const body = document.getElementById("resultsBody");
      if (!items || !items.length) {
        body.innerHTML = "";
        document.getElementById("resultsMsg").textContent = "No results yet. Run a scan.";
        document.getElementById("resultsMsg").className = "msg msg-info"; return;
      }
      document.getElementById("resultsMsg").textContent = "";
      body.innerHTML = items.map(r => {
        const factors = (r.factors || []).slice(0, 5).join(", ");
        const time = new Date(r.timestamp).toISOString().replace("T", " ").replace("Z", "");
        return `<tr>
          <td style="white-space:nowrap;font-size:0.74rem;">${time}</td>
          <td style="white-space:nowrap;">${r.sender_domain || "‚Äî"}</td>
          <td style="font-weight:700;color:var(--green);">${r.risk_score}</td>
          <td>${riskBadge(r.risk_level)}</td>
          <td style="font-size:0.73rem;color:var(--text-muted);">${factors || "‚Äî"}</td>
        </tr>`;
      }).join("");
    }

    function updateKPIs(d) {
      const total = d.total_count || 0, flagged = d.flagged_count || 0, safe = total - flagged;
      document.getElementById("kpi-flagged").textContent  = flagged;
      document.getElementById("kpi-safe").textContent     = safe;
      document.getElementById("kpi-total").textContent    = total;
      document.getElementById("kpi-flag-pct").textContent = total ? Math.round(flagged/total*100)+"%" : "‚Äì";
      document.getElementById("kpi-safe-pct").textContent = total ? Math.round(safe/total*100)+"%" : "‚Äì";
      document.getElementById("flaggedCount").textContent = flagged;
      document.getElementById("totalCount").textContent   = total;
    }

    async function loadSettings() {
      if (!state.apiKey) return;
      const s = await api("/api/settings");
      document.getElementById("setScanLimit").value = s.scan_limit;
      document.getElementById("setThreshold").value = s.risk_threshold;
      document.getElementById("setFrequency").value = s.scan_frequency_minutes;
      document.getElementById("scanLimit").value    = s.scan_limit;
    }

    async function loadDashboard() {
      if (!state.apiKey) return;
      const d = await api("/api/dashboard");
      updateKPIs(d);
      renderTopFactors(d.top_factors || []);

      const distLabels = ["Low","Medium","High","Critical"];
      const distValues = distLabels.map(k => (d.distribution || {})[k] || 0);
      const trendLabels = (d.trend || []).map(x => x.day);
      const trendAvg    = (d.trend || []).map(x => x.avg_risk);
      const trendCount  = (d.trend || []).map(x => x.count);

      if (state.distChart)  state.distChart.destroy();
      if (state.trendChart) state.trendChart.destroy();

      state.distChart = new Chart(document.getElementById("distChart"), {
        type: "bar",
        data: {
          labels: distLabels,
          datasets: [{
            label: "Emails",
            data: distValues,
            backgroundColor: ["rgba(0,208,132,.55)","rgba(245,200,66,.55)","rgba(249,115,22,.55)","rgba(244,63,94,.55)"],
            borderColor:     ["#00d084","#f5c842","#f97316","#f43f5e"],
            borderWidth: 1, borderRadius: 5,
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { color: 'rgba(255,255,255,0.04)' }, ticks: { color: '#5a5a5a' } },
            y: { grid: { color: 'rgba(255,255,255,0.04)' }, ticks: { color: '#5a5a5a' }, beginAtZero: true }
          }
        }
      });

      state.trendChart = new Chart(document.getElementById("trendChart"), {
        type: "line",
        data: {
          labels: trendLabels,
          datasets: [
            {
              label: "Avg Risk",
              data: trendAvg,
              borderColor: "#00d084",
              backgroundColor: "rgba(0,208,132,0.08)",
              tension: 0.4, fill: true, yAxisID: "y",
              pointBackgroundColor: "#00d084", pointRadius: 3,
            },
            {
              label: "Count",
              data: trendCount,
              borderColor: "rgba(0,208,132,0.35)",
              tension: 0.4, yAxisID: "y1",
              pointRadius: 2, borderDash: [4,3],
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x:  { grid: { color: 'rgba(255,255,255,0.04)' }, ticks: { color: '#5a5a5a' } },
            y:  { beginAtZero:true, suggestedMax:100, grid:{color:'rgba(255,255,255,0.04)'}, ticks:{color:'#5a5a5a'}, title:{display:true,text:'Risk',color:'#5a5a5a'} },
            y1: { beginAtZero:true, position:"right", grid:{drawOnChartArea:false}, ticks:{color:'#5a5a5a'}, title:{display:true,text:'Count',color:'#5a5a5a'} },
          }
        }
      });
    }

    async function loadResults() {
      if (!state.apiKey) return;
      const r = await api("/api/results?limit=200");
      renderResults(r.items || []);
    }

    // Tab buttons
    document.querySelectorAll(".tabBtn").forEach(btn => {
      btn.addEventListener("click", () => showTab(btn.getAttribute("data-tab")));
    });

    document.getElementById("provider").addEventListener("change", e => {
      document.getElementById("customImap").style.display = e.target.value === "custom" ? "block" : "none";
    });

    document.getElementById("connectForm").addEventListener("submit", async e => {
      e.preventDefault();
      const msg = document.getElementById("connectMsg");
      msg.className = "msg msg-info"; msg.textContent = "Connecting‚Ä¶";
      try {
        const provider    = document.getElementById("provider").value;
        const email       = document.getElementById("email").value.trim();
        const username    = document.getElementById("username").value.trim();
        const app_password= document.getElementById("appPassword").value;
        const body = { provider, email, username: username || null, app_password };
        if (provider === "custom") {
          body.imap_host = document.getElementById("imapHost").value.trim();
          body.imap_port = parseInt(document.getElementById("imapPort").value || "993", 10);
          body.use_ssl   = document.getElementById("useSsl").checked;
        }
        const res = await api("/api/connect/imap", { method:"POST", body });
        state.apiKey = res.api_key;
        localStorage.setItem("apiKey", state.apiKey);
        setAuthUI();
        await loadSettings().catch(() => {});
        msg.className = "msg msg-ok"; msg.textContent = "‚úî Connected. You can now scan emails.";
      } catch(err) {
        msg.className = "msg msg-err"; msg.textContent = "‚úò " + (err.message || "Connect failed");
      }
    });

    document.getElementById("scanBtn").addEventListener("click", async () => {
      const msg = document.getElementById("scanMsg");
      msg.className = "msg msg-info"; msg.textContent = "Scanning‚Ä¶";
      try {
        const limit = parseInt(document.getElementById("scanLimit").value || "50", 10);
        const res = await api("/api/scan", { method:"POST", body:{limit} });
        msg.className = "msg msg-ok";
        msg.textContent = `‚úî Scanned ${res.scanned}, stored ${res.stored} metrics.`;
        await loadDashboard().catch(() => {});
        await loadResults().catch(() => {});
      } catch(err) {
        msg.className = "msg msg-err"; msg.textContent = "‚úò " + (err.message || "Scan failed");
      }
    });

    document.getElementById("settingsForm").addEventListener("submit", async e => {
      e.preventDefault();
      const msg = document.getElementById("settingsMsg");
      msg.className = "msg msg-info"; msg.textContent = "Saving‚Ä¶";
      try {
        const body = {
          scan_limit:             parseInt(document.getElementById("setScanLimit").value, 10),
          risk_threshold:         parseInt(document.getElementById("setThreshold").value, 10),
          scan_frequency_minutes: parseInt(document.getElementById("setFrequency").value, 10),
        };
        await api("/api/settings", { method:"POST", body });
        msg.className = "msg msg-ok"; msg.textContent = "‚úî Settings saved.";
        document.getElementById("scanLimit").value = body.scan_limit;
      } catch(err) {
        msg.className = "msg msg-err"; msg.textContent = "‚úò " + (err.message || "Save failed");
      }
    });

    document.getElementById("refreshDashBtn").addEventListener("click",    () => loadDashboard().catch(() => {}));
    document.getElementById("refreshResultsBtn").addEventListener("click", () => loadResults().catch(() => {}));

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("apiKey"); state.apiKey = "";
      ["email","username","appPassword","imapHost","imapPort"].forEach(id => {
        const el = document.getElementById(id); if (el) el.value = "";
      });
      const p = document.getElementById("provider"); if (p) p.value = "gmail";
      const s = document.getElementById("useSsl");   if (s) s.checked = true;
      document.getElementById("customImap").style.display = "none";
      ["connectMsg","scanMsg","settingsMsg"].forEach(id => {
        const el = document.getElementById(id); if (el) el.textContent = "";
      });
      setAuthUI(); showTab("connect");
    });

    setAuthUI();
    showTab("connect");
    if (state.apiKey) loadSettings().catch(() => {});
  </script>
</body>
</html>